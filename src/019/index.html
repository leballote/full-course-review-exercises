<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Example 19</title>
  </head>
  <body>
    <ul id="results"></ul>
    <!-- <script src="nb-test.js"></script> -->
    <script>
      (function (global) {
        let root = document.getElementById("results");
        //this is one way to achieve it. I think, it would be better to change the assert function to accept root as a parameter but don't know if that is an option
        const originalSetTimeout = setTimeout;
        setTimeout = function (fn, ...rest) {
          let temp = root;
          const modFn = function (...args) {
            root = temp;
            return fn(...args);
          };
          return originalSetTimeout(modFn, ...rest);
        };
        const result = (text, pass) => {
          const el = document.createElement("li");
          el.textContent = text;
          pass !== undefined && (el.style.color = pass ? "green" : "red");
          return el;
        };
        const assert = (pass, message) => {
          return root.appendChild(result(message, pass));
        };
        function test(description, testBlock) {
          const parent = root;
          root = assert(undefined, description).appendChild(
            document.createElement("ul")
          );
          testBlock();
          root = parent;
        }
        global.assert = assert;
        global.test = test;
      })(window);
    </script>
    <script type="module">
      assert(true, "Outside and before the test block");

      test("TestBlock A", function () {
        assert(true, "Inside TestBlock A");
        setTimeout(() => assert(true, "test delayed A"), 1000);
      });
      assert(true, "Outside and after the TestBlock A");
      test("TestBlock B", function () {
        assert(true, "Inside TestBlock B");
        setTimeout(assert, 500, true, "test delayed B");
      });
      assert(true, "Outside and after TestBlock B");
    </script>
  </body>
</html>
